<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Analyzer — XSMB + Vietlott (Mega/Power/Max3D/Lotto 5/35)</title>
<meta name="description" content="Phân tích XSMB lô 2 số cuối và dự đoán Vietlott: Mega 6/45, Power 6/55, Max 3D, Lotto 5/35 (5 số + 1 đặc biệt). Tự dự đoán 13:00 & 21:00 GMT+7.">
<style>
  :root{--bg:#0a1110;--card:#0f1916;--text:#f6fbff;--muted:#a8c3b6;--acc:#00e6a8;--border:#173228;--pill:#0b1a15}
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto;color:var(--text);background:linear-gradient(180deg,#06100d,#0a1110 55%,#0a1110)}
  .wrap{max-width:1200px;margin:34px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 16px;box-shadow:0 8px 26px rgba(0,0,0,.38);margin-bottom:16px}
  h1{margin:0 0 6px;font-size:26px} h2{margin:8px 0 4px;font-size:20px}
  .muted{color:var(--muted);font-size:14px} .small{font-size:12px;opacity:.9}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{cursor:pointer;border:1px solid #2a6b57;background:#0f2a22;color:#eafff7;border-radius:10px;padding:8px 12px}
  .btn:hover{filter:brightness(1.07)}
  .pill{display:inline-block;margin:6px 6px 0 0;padding:7px 12px;border-radius:999px;border:1px solid #1f5646;background:var(--pill)}
  .box{background:#0d1814;border:1px dashed #1a3e33;border-radius:10px;padding:10px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  pre{white-space:pre-wrap;word-wrap:break-word}
  .tag{border:1px solid #335d50;background:#10241e;padding:6px 10px;border-radius:8px}
  table{width:100%;border-collapse:collapse} th,td{border:1px solid #1e3e33;padding:6px 8px;font-size:14px} th{background:#0d1814}
  details{border:1px solid var(--border);border-radius:10px;padding:10px;background:#0d1814} details>summary{cursor:pointer}
  textarea{width:100%;min-height:80px;background:#08130f;color:#eafff7;border:1px solid #224a3e;border-radius:8px;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>🎯 Analyzer — XSMB + Vietlott</h1>
    <div class="muted">XSMB (2 số cuối) + Vietlott: Mega 6/45, Power 6/55, Max 3D, và <b>Lotto 5/35</b> (5 số + 1 đặc biệt). Tự sinh dự đoán lúc <b>13:00</b> & <b>21:00</b> theo <b>GMT+7</b>. 1 file duy nhất — chỉ cần tải lên web là dùng.</div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="refreshAll">↻ Làm mới tất cả</button>
      <button class="btn" id="exportJson">⬇️ Xuất lịch sử</button>
      <button class="btn" id="importJson">⬆️ Nhập lịch sử</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button class="btn" id="wipeAll">🧹 Xoá lịch sử cục bộ</button>
      <span class="muted" id="status">Đang khởi động…</span>
    </div>
    <div class="small" style="margin-top:6px">Miễn trừ: công cụ thống kê/học máy tham khảo; không đảm bảo trúng. Thời gian thực phụ thuộc trang nguồn.</div>
  </div>

  <div class="card">
    <h2>📊 XSMB — Lô 2 số cuối (27 giải)</h2>
    <div class="row">
      <span class="tag">Nguồn: <b id="xsmb-src">—</b></span>
      <span class="tag">Cập nhật: <b id="xsmb-updated">—</b></span>
      <span class="tag">Best pick: <b id="xsmb-best">—</b></span>
      <span class="tag">Confidence: <b id="xsmb-conf">—</b></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="xsmb-refresh">↻ Làm mới XSMB</button>
      <button class="btn" id="xsmb-copy">📋 Copy chi tiết</button>
    </div>
    <div class="grid" style="margin-top:12px">
      <div class="box">
        <b>Top 10 hôm nay</b>
        <div id="xsmb-top" style="margin-top:6px"></div>
      </div>
      <div class="box">
        <b>Phân tích</b>
        <pre id="xsmb-detail" style="margin-top:6px">Đang tải…</pre>
      </div>
    </div>
    <details style="margin-top:10px">
      <summary>Nhập tay (khi nguồn đổi layout)</summary>
      <textarea id="xsmb-manual" placeholder="Dán tất cả số trúng trong ngày (cách nhau bởi khoảng trắng/xuống dòng)"></textarea>
      <div class="row" style="margin-top:6px"><button class="btn" id="xsmb-apply">✔️ Áp dụng</button></div>
    </details>
  </div>

  <div class="card">
    <h2>🔮 Vietlott — 5 bộ dự đoán ở 13:00 & 21:00 (GMT+7)</h2>
    <div class="grid" style="margin-top:10px">
      <div class="box">
        <b>Mega 6/45</b>
        <div id="mega-meta" class="small" style="margin-top:4px">—</div>
        <table style="margin-top:6px"><thead><tr><th>Thời điểm</th><th>5 gợi ý</th></tr></thead><tbody id="mega-picks"></tbody></table>
        <div class="row" style="margin-top:8px"><button class="btn" id="mega-refresh">↻ Cập nhật + dự đoán</button><button class="btn" id="mega-copy">📋 Copy</button></div>
      </div>
      <div class="box">
        <b>Power 6/55</b>
        <div id="power-meta" class="small" style="margin-top:4px">—</div>
        <table style="margin-top:6px"><thead><tr><th>Thời điểm</th><th>5 gợi ý</th></tr></thead><tbody id="power-picks"></tbody></table>
        <div class="row" style="margin-top:8px"><button class="btn" id="power-refresh">↻ Cập nhật + dự đoán</button><button class="btn" id="power-copy">📋 Copy</button></div>
      </div>
      <div class="box">
        <b>Max 3D</b>
        <div id="max3d-meta" class="small" style="margin-top:4px">—</div>
        <table style="margin-top:6px"><thead><tr><th>Thời điểm</th><th>5 gợi ý</th></tr></thead><tbody id="max3d-picks"></tbody></table>
        <div class="row" style="margin-top:8px"><button class="btn" id="max3d-refresh">↻ Cập nhật + dự đoán</button><button class="btn" id="max3d-copy">📋 Copy</button></div>
      </div>
      <div class="box">
        <b>Lotto 5/35</b> <span class="small">(5 số chính + 1 số đặc biệt 01–12)</span>
        <div id="l535-meta" class="small" style="margin-top:4px">—</div>
        <table style="margin-top:6px"><thead><tr><th>Thời điểm</th><th>5 gợi ý (5 số + SB)</th></tr></thead><tbody id="l535-picks"></tbody></table>
        <details style="margin-top:8px">
          <summary>Nhập tay kỳ gần nhất (khi nguồn lỗi)</summary>
          <textarea id="l535-manual" placeholder="VD: 01 07 14 25 26 | SB: 01"></textarea>
          <div class="row" style="margin-top:6px"><button class="btn" id="l535-apply">✔️ Lưu kỳ</button></div>
        </details>
        <div class="row" style="margin-top:8px"><button class="btn" id="l535-refresh">↻ Cập nhật + dự đoán</button><button class="btn" id="l535-copy">📋 Copy</button></div>
      </div>
    </div>
  </div>

  <div class="card small">
    <b>Nguồn tích hợp cho Lotto 5/35</b>
    <ul>
      <li><code>xskt.com.vn/xslotto-5-35</code> (kênh kết quả & thống kê).</li>
      <li><code>minhchinh.com/truc-tiep-xo-so-tu-chon-lotto-535.html</code> (trực tiếp + lịch sử các kỳ).</li>
    </ul>
    <div class="small">Nếu bạn có thêm URL nguồn chính thức khác, mở file và bổ sung vào danh sách <code>SRC.l535</code> (phần CONFIG).</div>
  </div>
</div>

<script>
/* ============================== CONFIG & UTILS ============================== */
const PROXY = (url) => "https://r.jina.ai/http://" + url.replace(/^https?:\/\//,'');
const SRC = {
  xsmb: [
    "https://ketqua.net/",
    "https://xoso.com.vn/xsmb-xo-so-mien-bac.html",
    "https://www.minhngoc.net.vn/ket-qua-xo-so/mien-bac.html"
  ],
  mega: [
    "https://xoso.com.vn/kqxs-vietlott-mega-6-45.html",
    "https://vietlott.vn/vi/ket-qua-trung-thuong/mega-6-45"
  ],
  power: [
    "https://xoso.com.vn/kqxs-vietlott-power-6-55.html",
    "https://vietlott.vn/vi/ket-qua-trung-thuong/power-6-55"
  ],
  max3d: [
    "https://xoso.com.vn/vietlott-max-3d.html",
    "https://xoso.com.vn/vietlott-max-3d-plus.html",
    "https://vietlott.vn/vi/ket-qua-trung-thuong/max-3d"
  ],
  l535: [
    "https://xskt.com.vn/xslotto-5-35",
    "https://xskt.com.vn/xslotto-13h",
    "https://xskt.com.vn/xslotto-21h",
    "https://www.minhchinh.com/truc-tiep-xo-so-tu-chon-lotto-535.html",
    "https://www.minhchinh.com/xo-so-dien-toan-lotto-535.html"
  ]
};
const PICK_HOURS = [13,21]; // GMT+7
const pad2 = n=>('0'+n).slice(-2);
const pad3 = n=>('00'+n).slice(-3);
const LS = {
  xsmb:"hist_xsmb_p", mega:"hist_mega_p", power:"hist_power_p", max3d:"hist_max3d_p",
  l535:"hist_l535_p", picks:"picks_p"
};
function nowGMT7(){ const d=new Date(); const t=d.getTime(); const off=d.getTimezoneOffset(); return new Date(t + (7*60 + off)*60000); }
const todayISO = ()=> nowGMT7().toISOString().slice(0,10);
function setStatus(s){ document.getElementById('status').textContent = s; }
function loadHist(k){ try{return JSON.parse(localStorage.getItem(k)||"[]")}catch(_){return[]} }
function saveHist(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
function uniqPreserve(arr){ const set=new Set(), out=[]; for(const x of arr){ if(!set.has(x)){ set.add(x); out.push(x);} } return out; }
async function fetchTextFrom(urls){
  for(const url of urls){
    try{ const r=await fetch(PROXY(url),{cache:'no-store'}); if(r.ok){ return {text:await r.text(), source:url}; } }catch(_){}
  }
  throw new Error("Không truy cập được nguồn.");
}
function countMap(arr){ const m=new Map(); for(const x of arr){ m.set(x,(m.get(x)||0)+1); } return m; }
function topNFromMap(m, n){ return [...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n); }
function stableSeed(seedStr){ let h=2166136261>>>0; for(let i=0;i<seedStr.length;i++){ h^=seedStr.charCodeAt(i); h=(h>>>0)*16777619>>>0;} return function(){h^=h<<13;h^=h>>>17;h^=h<<5; return (h>>>0)/0xFFFFFFFF;}; }
function weightedSample(probArray, k, noRepeat=true, rng=Math.random){
  const out=[]; const arr=probArray.map(x=>({val:x.val,p:x.p}));
  for(let i=0;i<k;i++){
    const sum=arr.reduce((s,x)=>s+x.p,0);
    if(sum<=0) break;
    let r=rng()*sum, j=0;
    for(; j<arr.length; j++){ r-=arr[j].p; if(r<=0) break; }
    if(j>=arr.length) j=arr.length-1;
    out.push(arr[j].val);
    if(noRepeat){ arr.splice(j,1); }
  }
  return out;
}

/* ============================== XSMB ============================== */
function parseXsmbTwos(text){
  const all=(text.match(/\b\d{2,6}\b/g)||[]).map(s=>s.trim());
  const twos=all.map(s=>s.slice(-2)).filter(s=>/^\d{2}$/.test(s));
  let out=uniqPreserve(twos);
  if(out.length>60) out=out.slice(0,60);
  if(out.length<20) out=twos.slice(0,60);
  return out;
}
function upsertXsmb(twos){
  const d=todayISO(); const hist=loadHist(LS.xsmb);
  const idx=hist.findIndex(r=>r.date===d);
  if(idx>=0) hist[idx].twos=twos; else hist.push({date:d, twos});
  hist.sort((a,b)=>a.date<b.date?-1:1); saveHist(LS.xsmb, hist); return hist;
}
function xsmbFrequency(hist, days){
  const cut = new Date(nowGMT7().getTime()-days*86400000);
  const cISO = cut.toISOString().slice(0,10);
  const arr=[]; for(const r of hist){ if(r.date>=cISO) arr.push(...r.twos); }
  return countMap(arr);
}
function xsmbScore(hist){
  const f7=xsmbFrequency(hist,7), f14=xsmbFrequency(hist,14), f30=xsmbFrequency(hist,30);
  const ema=new Map(); const alpha=0.2; for(const r of hist){ for(const n of r.twos){ ema.set(n,(ema.get(n)||0)*(1-alpha)+alpha); } }
  const all=[...Array(100)].map((_,i)=>pad2(i));
  const scored=all.map(lo=>({lo, s:(f30.get(lo)||0)*1 + (f14.get(lo)||0)*0.6 + (f7.get(lo)||0)*0.4 + (ema.get(lo)||0)*2})).sort((a,b)=>b.s-a.s);
  return {scored,f7,f14,f30};
}
function xsmbFun(hist){
  const last=hist[hist.length-1]; if(!last) return [];
  const set=new Set(last.twos); const mirrors=[],neighbors=[];
  set.forEach(n=>{ const m=n.split('').reverse().join(''); if(m!==n) mirrors.push(m); const d=parseInt(n,10); neighbors.push(pad2((d+1)%100)); neighbors.push(pad2((d+99)%100)); });
  return uniqPreserve([...mirrors,...neighbors]).slice(0,10);
}
async function refreshXSMB(){
  setStatus("Đang lấy XSMB…");
  const {text, source}=await fetchTextFrom(SRC.xsmb);
  const twos=parseXsmbTwos(text);
  const hist=upsertXsmb(twos);
  document.getElementById('xsmb-src').textContent=source.replace(/^https?:\/\//,'');
  document.getElementById('xsmb-updated').textContent=nowGMT7().toLocaleString();
  const {scored,f7,f14,f30}=xsmbScore(hist);
  const best=scored[0]?.lo||'—'; const conf=(scored[0]?.s||0)/((scored[9]?.s||1));
  document.getElementById('xsmb-best').textContent=best; document.getElementById('xsmb-conf').textContent=Math.min(0.99,conf).toFixed(2);
  const box=document.getElementById('xsmb-top'); box.innerHTML=''; scored.slice(0,10).forEach(x=>{ const s=document.createElement('span'); s.className='pill'; s.textContent=x.lo; box.appendChild(s); });
  const lines=[
    `Hôm nay (27 giải → 2 số cuối): ${twos.join(' ')}`,'',
    'Top 10 — điểm tổng hợp: '+scored.slice(0,10).map(x=>x.lo).join(', '),
    'Top 10 — 7 ngày: '+topNFromMap(f7,10).map(([n,c])=>`${n}(${c})`).join(', '),
    'Top 10 — 14 ngày: '+topNFromMap(f14,10).map(([n,c])=>`${n}(${c})`).join(', '),
    'Top 10 — 30 ngày: '+topNFromMap(f30,10).map(([n,c])=>`${n}(${c})`).join(', '),
    '',
    'Gợi ý “bạc nhớ / cầu” (vui): '+xsmbFun(hist).join(', ')
  ];
  document.getElementById('xsmb-detail').textContent=lines.join('\n');
  setStatus("XSMB OK.");
}

/* ============================== Generic prob engine ============================== */
function probsFromHistory(hist, max, windowK=30, decayAlpha=0.15){
  const tail=hist.slice(-windowK); const counts=new Array(max+1).fill(0); const ema=new Array(max+1).fill(0);
  for(const r of tail){ const set=new Set(r.nums); for(let i=1;i<=max;i++){ const has=set.has(pad2(i)); if(has) counts[i]++; ema[i]=ema[i]*(1-decayAlpha)+(has?decayAlpha:0); } }
  const arr=[]; for(let i=1;i<=max;i++){ const p=counts[i]*1 + ema[i]*5; arr.push({val:pad2(i), p}); } const sum=arr.reduce((s,x)=>s+x.p,0)||1; arr.forEach(o=>o.p=o.p/sum); return arr;
}
function makePicks(probArr, k, seed){
  const rng=stableSeed(seed); const orig=Math.random; Math.random=rng;
  const sorted=[...probArr].sort((a,b)=>b.p-a.p);
  const hot=sorted.slice(0,k).map(x=>x.val);
  const cold=sorted.slice(-k).map(x=>x.val);
  const mid=sorted.slice(Math.floor(sorted.length*0.3), Math.floor(sorted.length*0.7));
  const mixed=uniqPreserve([...sorted.slice(0,3).map(x=>x.val), ...weightedSample(mid, k-3, true, Math.random)]).slice(0,k);
  const emaW=weightedSample(probArr, k, true, Math.random);
  const random=weightedSample(probArr.map(x=>({val:x.val,p:1})), k, true, Math.random);
  Math.random=orig; return [hot,cold,mixed,emaW,random];
}
function shouldPickNow(keyPrefix){
  const now=nowGMT7(); const h=now.getHours(); const d=now.toISOString().slice(0,10);
  if(!PICK_HOURS.includes(h)) return {ok:false};
  const seen=JSON.parse(localStorage.getItem(LS.picks)||"{}"); const key=`${keyPrefix}|${d}|${h}`; if(seen[key]) return {ok:false}; seen[key]=true; localStorage.setItem(LS.picks, JSON.stringify(seen)); return {ok:true,label:`${d} ${pad2(h)}:00`};
}
function renderRow(tbodyId, when, sets){ const tr=document.createElement('tr'); const td1=document.createElement('td'); td1.textContent=when; tr.appendChild(td1); const td2=document.createElement('td'); td2.innerHTML=sets.map(s=>'<span class="pill">'+s.join(' ')+'</span>').join(' '); tr.appendChild(td2); document.getElementById(tbodyId).prepend(tr); }

/* ============================== Mega / Power ============================== */
function parseRangeGroup(text, max, groupSize){
  const rx = new RegExp(`\\b(0?[1-9]|${max<50?'[1-3]':'[1-7]'}\\d|${max})\\b`,'g');
  const nums=(text.match(rx)||[]).map(n=>pad2(n)).filter(n=>parseInt(n,10)>=1 && parseInt(n,10)<=max);
  const groups=[]; let cur=[]; for(const n of nums){ cur.push(n); if(cur.length===groupSize){ groups.push(cur); cur=[]; } } return groups.length? groups[groups.length-1] : [];
}
function upsertSimple(histKey, numbers){
  const hist=loadHist(histKey); const key=todayISO()+'|'+numbers.join('-'); if(!hist.find(r=>r.key===key)) hist.push({key, nums:numbers}); if(hist.length>300) hist.splice(0, hist.length-300); saveHist(histKey, hist); return hist;
}
async function refreshGameAndPredict({name, srcList, max, k, histKey, metaId, tbodyId, copyId}){
  setStatus(`Đang lấy ${name}…`); try{
    const {text, source}=await fetchTextFrom(srcList); const latest=parseRangeGroup(text, max, k); if(latest.length===k) upsertSimple(histKey, latest);
    document.getElementById(metaId).textContent = `Nguồn: ${source.replace(/^https?:\/\//,'')} • Kỳ mới nhất: ${latest.join(' ')||'—'} • ${nowGMT7().toLocaleString()}`;
  }catch(e){ document.getElementById(metaId).textContent = `Không đọc được nguồn (${nowGMT7().toLocaleString()}) — dùng lịch sử cục bộ để dự đoán.`; }
  const hist=loadHist(histKey); const probs=probsFromHistory(hist, max); const slot=shouldPickNow(name); const when=slot.ok?slot.label: nowGMT7().toLocaleString('en-GB',{hour12:false}); const sets=makePicks(probs,k,`${name}|${when}`); renderRow(tbodyId, when, sets);
  document.getElementById(copyId).onclick=()=>{ const tr=document.querySelector(`#${tbodyId} tr`); if(!tr) return alert("Chưa có dòng dự đoán."); const t=tr.children[0].textContent; const s=[...tr.children[1].querySelectorAll('.pill')].map(x=>x.textContent).join(' | '); navigator.clipboard.writeText(`${name} ${t}: ${s}`).then(()=>alert("Đã copy!")); };
  setStatus(`${name} OK.`);
}

/* ============================== Max 3D ============================== */
function parse3D(text){ return uniqPreserve((text.match(/\b\d{3}\b/g)||[]).map(x=>pad3(x))).slice(-60); }
function upsertMax3D(list){ const hist=loadHist(LS.max3d); const key=todayISO()+'|'+list.join('-'); if(!hist.find(r=>r.key===key)) hist.push({key, nums:list}); if(hist.length>300) hist.splice(0, hist.length-300); saveHist(LS.max3d, hist); return hist; }
function probsMax3D(windowK=30, alpha=0.2){
  const hist=loadHist(LS.max3d).slice(-windowK); const counts=new Map(); for(const r of hist){ for(const n of r.nums){ counts.set(n,(counts.get(n)||0)+1); } }
  const pH=new Array(10).fill(0.1), pT=new Array(10).fill(0.1), pU=new Array(10).fill(0.1); for(const [n,c] of counts.entries()){ const h=+n[0],t=+n[1],u=+n[2]; pH[h]+=c*0.02; pT[t]+=c*0.02; pU[u]+=c*0.02; }
  function pick3(seed){ const rng=stableSeed(seed); function wp(ps){ const a=ps.map((p,i)=>({i,p})); const s=a.reduce((x,y)=>x+y.p,0); let r=rng()*s; for(const o of a){ r-=o.p; if(r<=0) return o.i; } return a[a.length-1].i; } return ''+wp(pH)+''+wp(pT)+''+wp(pU); }
  return {pick3};
}
async function refreshMax3D(){
  setStatus("Đang lấy Max3D…");
  try{ const {text, source}=await fetchTextFrom(SRC.max3d); const list=parse3D(text); if(list.length) upsertMax3D(list); document.getElementById('max3d-meta').textContent = `Nguồn: ${source.replace(/^https?:\/\//,'')} • ${nowGMT7().toLocaleString()} • Gần nhất: ${list.slice(-6).join(' ')||'—'}`;
  }catch(e){ document.getElementById('max3d-meta').textContent = `Không đọc được nguồn (${nowGMT7().toLocaleString()}) — dùng lịch sử cục bộ để dự đoán.`; }
  const {pick3}=probsMax3D(); const slot=shouldPickNow('max3d'); const when=slot.ok?slot.label: nowGMT7().toLocaleString('en-GB',{hour12:false}); const sets=[0,1,2,3,4].map(i=>pick3(`max3d|${when}|${i}`));
  renderRow('max3d-picks', when, sets); document.getElementById('max3d-copy').onclick=()=>{ const tr=document.querySelector('#max3d-picks tr'); if(!tr) return alert("Chưa có dòng dự đoán."); const t=tr.children[0].textContent; const s=[...tr.children[1].querySelectorAll('.pill')].map(x=>x.textContent).join(' | '); navigator.clipboard.writeText(`max3d ${t}: ${s}`).then(()=>alert("Đã copy!")); };
  setStatus("Max3D OK.");
}

/* ============================== Lotto 5/35 (5 số + 1 SB) ============================== */
function parseL535(text){
  // Find the latest group of 6 numbers where 5 are 01..35 and 1 is 01..12 (special)
  const nums=(text.match(/\b\d{2}\b/g)||[]).map(x=>x.trim());
  let best=null;
  for(let i=0;i+5<nums.length;i++){
    const g=nums.slice(i,i+6).map(s=>parseInt(s,10));
    const main=g.slice(0,5), sp=g[5];
    const mainOk=main.every(v=>v>=1&&v<=35), spOk=sp>=1&&sp<=12;
    if(mainOk && spOk){ best = {main: main.map(x=>('0'+x).slice(-2)), sp: ('0'+sp).slice(-2)}; }
  }
  return best? best : {main:[], sp:''};
}
function upsertL535(obj){
  if(!obj.main.length || !obj.sp) return;
  const hist=loadHist(LS.l535);
  const key=todayISO()+'|'+obj.main.join('-')+'|'+obj.sp;
  if(!hist.find(r=>r.key===key)) hist.push({key, nums:new Set(obj.main).size===5?obj.main:uniqPreserve(obj.main), sp:obj.sp});
  if(hist.length>400) hist.splice(0, hist.length-400);
  saveHist(LS.l535, hist); return hist;
}
function probsL535(){
  const hist=loadHist(LS.l535).slice(-60);
  // main 1..35
  const counts=new Array(36).fill(0), ema=new Array(36).fill(0);
  const alpha=0.15;
  for(const r of hist){ const set=new Set(r.nums); for(let i=1;i<=35;i++){ const has=set.has(pad2(i)); if(has) counts[i]++; ema[i]=ema[i]*(1-alpha)+(has?alpha:0); } }
  const arr=[]; for(let i=1;i<=35;i++){ const p=counts[i]*1 + ema[i]*5; arr.push({val:pad2(i), p}); }
  const sum=arr.reduce((s,x)=>s+x.p,0)||1; arr.forEach(o=>o.p=o.p/sum);
  // special 1..12
  const sc=new Array(13).fill(0), se=new Array(13).fill(0);
  for(const r of hist){ const s=parseInt(r.sp,10); if(s>=1&&s<=12){ sc[s]++; se[s]=se[s]*(1-alpha)+alpha; } }
  const sArr=[]; for(let i=1;i<=12;i++){ const p= (sc[i]*1 + se[i]*5); sArr.push({val:pad2(i), p}); } const sSum=sArr.reduce((s,x)=>s+x.p,0)||1; sArr.forEach(o=>o.p=o.p/sum);
  return {arr, sArr};
}
async function refreshL535(){
  setStatus("Đang lấy Lotto 5/35…");
  let sourceUsed = 'manual/LS'; let latestTxt='—';
  try{
    const {text, source}=await fetchTextFrom(SRC.l535);
    const obj=parseL535(text);
    if(obj.main.length){ upsertL535(obj); latestTxt = obj.main.join(' ') + ' | SB ' + obj.sp; sourceUsed = source.replace(/^https?:\/\//,''); }
  }catch(e){ /* fallback to local */ }
  document.getElementById('l535-meta').textContent = `Nguồn: ${sourceUsed} • ${nowGMT7().toLocaleString()} • Kỳ mới nhất: ${latestTxt}`;
  // predict
  const hist=loadHist(LS.l535);
  const {arr,sArr}=probsL535();
  const slot=shouldPickNow('l535'); const when=slot.ok?slot.label: nowGMT7().toLocaleString('en-GB',{hour12:false});
  const sets = makePicks(arr, 5, `l535|${when}`).map(main => {
    const sp = weightedSample(sArr, 1, true, stableSeed(`l535|sp|${when}|${main.join('-')}`))[0] || '01';
    return [...main, '•', 'SB', sp];
  });
  renderRow('l535-picks', when, sets);
  document.getElementById('l535-copy').onclick = ()=>{
    const tr=document.querySelector('#l535-picks tr'); if(!tr) return alert("Chưa có dòng dự đoán.");
    const t=tr.children[0].textContent; const s=[...tr.children[1].querySelectorAll('.pill')].map(x=>x.textContent).join(' | ');
    navigator.clipboard.writeText(`Lotto 5/35 ${t}: ${s}`).then(()=>alert("Đã copy!"));
  };
  setStatus("Lotto 5/35 OK.");
}

/* ============================== UI EVENTS ============================== */
document.getElementById('refreshAll').onclick = async ()=>{
  try{
    await refreshXSMB();
    await refreshGameAndPredict({name:'mega', srcList:SRC.mega, max:45, k:6, histKey:LS.mega, metaId:'mega-meta', tbodyId:'mega-picks', copyId:'mega-copy'});
    await refreshGameAndPredict({name:'power', srcList:SRC.power, max:55, k:6, histKey:LS.power, metaId:'power-meta', tbodyId:'power-picks', copyId:'power-copy'});
    await refreshMax3D();
    await refreshL535();
    setStatus("Hoàn tất.");
  }catch(e){ setStatus("Lỗi: "+e.message); }
};
document.getElementById('exportJson').onclick = ()=>{
  const obj={}; for(const [k,v] of Object.entries(LS)){ obj[k]=loadHist(v); }
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='lottery_history.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
};
document.getElementById('importJson').onclick = ()=>document.getElementById('importFile').click();
document.getElementById('importFile').onchange = (e)=>{
  const f=e.target.files[0]; if(!f) return; const reader=new FileReader();
  reader.onload=()=>{ try{ const data=JSON.parse(reader.result); for(const [k,v] of Object.entries(data||{})){ if(LS[k]) saveHist(LS[k], v); } alert("Đã nhập lịch sử."); } catch(_){ alert("File JSON không hợp lệ."); } };
  reader.readAsText(f);
};
document.getElementById('wipeAll').onclick = ()=>{ Object.values(LS).forEach(k=>localStorage.removeItem(k)); alert("Đã xoá lịch sử cục bộ."); };

// XSMB buttons
document.getElementById('xsmb-refresh').onclick = refreshXSMB;
document.getElementById('xsmb-copy').onclick = ()=>{ const t=document.getElementById('xsmb-detail').textContent; navigator.clipboard.writeText(t).then(()=>alert('Đã copy!')); };
document.getElementById('xsmb-apply').onclick = ()=>{
  const raw=(document.getElementById('xsmb-manual').value||'').match(/\b\d{1,6}\b/g)||[];
  const twos=uniqPreserve(raw.map(s=>s.slice(-2).padStart(2,'0'))).slice(0,60);
  upsertXsmb(twos);
  document.getElementById('xsmb-updated').textContent=nowGMT7().toLocaleString()+" (manual)";
  const hist=loadHist(LS.xsmb); const {scored}=xsmbScore(hist);
  document.getElementById('xsmb-best').textContent=scored[0]?.lo||'—';
  const box=document.getElementById('xsmb-top'); box.innerHTML=''; scored.slice(0,10).forEach(x=>{ const s=document.createElement('span'); s.className='pill'; s.textContent=x.lo; box.appendChild(s); });
  document.getElementById('xsmb-detail').textContent="Đã lưu thủ công cho hôm nay: "+twos.join(' ');
};

// Mega / Power
document.getElementById('mega-refresh').onclick = ()=>refreshGameAndPredict({name:'mega', srcList:SRC.mega, max:45, k:6, histKey:LS.mega, metaId:'mega-meta', tbodyId:'mega-picks', copyId:'mega-copy'});
document.getElementById('power-refresh').onclick= ()=>refreshGameAndPredict({name:'power',srcList:SRC.power,max:55,k:6,histKey:LS.power,metaId:'power-meta',tbodyId:'power-picks', copyId:'power-copy'});

// Max3D
document.getElementById('max3d-refresh').onclick = refreshMax3D;

// Lotto 5/35
document.getElementById('l535-refresh').onclick = refreshL535;
document.getElementById('l535-apply').onclick = ()=>{
  const raw=(document.getElementById('l535-manual').value||'').match(/\b\d{1,2}\b/g)||[];
  if(raw.length<6) return alert("Cần 5 số chính (01–35) + 1 số đặc biệt (01–12).");
  const main=uniqPreserve(raw.slice(0,5).map(x=>('0'+x).slice(-2))).filter(n=>{const v=parseInt(n,10);return v>=1&&v<=35;}).slice(0,5);
  const sp=('0'+raw[5]).slice(-2); if(main.length!==5 || !(parseInt(sp,10)>=1 && parseInt(sp,10)<=12)) return alert("Dữ liệu chưa hợp lệ.");
  upsertL535({main, sp}); alert("Đã lưu 1 kỳ Lotto 5/35: "+main.join(' ')+" | SB "+sp); refreshL535();
};

/* ============================== BOOT ============================== */
(async function boot(){
  setStatus("Đang tải dữ liệu ban đầu…");
  try{ await refreshXSMB(); }catch(e){ setStatus("XSMB lỗi: "+e.message); }
  const now=nowGMT7(); if(PICK_HOURS.includes(now.getHours())){
    await refreshGameAndPredict({name:'mega', srcList:SRC.mega, max:45, k:6, histKey:LS.mega, metaId:'mega-meta', tbodyId:'mega-picks', copyId:'mega-copy'});
    await refreshGameAndPredict({name:'power', srcList:SRC.power, max:55, k:6, histKey:LS.power, metaId:'power-meta', tbodyId:'power-picks', copyId:'power-copy'});
    await refreshMax3D();
    await refreshL535();
  }
})();
</script>
</body>
</html>
