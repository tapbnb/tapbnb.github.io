name: Backfill histories (one-shot + weekly)

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 2 * * 1'   # 09:00 GMT+7 thứ Hai mỗi tuần

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Backfill histories (HTML archives + optional CSV)
        env:
          CSV_XSMB: ${{ secrets.CSV_XSMB }}
          CSV_MEGA: ${{ secrets.CSV_MEGA }}
          CSV_POWER: ${{ secrets.CSV_POWER }}
          CSV_MAX3D: ${{ secrets.CSV_MAX3D }}
          CSV_L535: ${{ secrets.CSV_L535 }}
        run: node scripts/backfill.mjs
      - name: Commit backfilled data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/hist data/dataset_ml.csv || true
          git diff --cached --quiet || git commit -m "Backfill histories"
          git push
